<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true" scanPeriod="60 seconds">
    
    <!-- ===================== 基础配置 ===================== -->
    <springProfile name="!prod">
        <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    </springProfile>
    
    <!-- 应用名称 -->
    <property name="APP_NAME" value="codetop-fsrs"/>
    
    <!-- 日志根目录 -->
    <springProfile name="dev,test">
        <property name="LOG_PATH" value="./logs"/>
    </springProfile>
    <springProfile name="prod">
        <property name="LOG_PATH" value="/var/log/${APP_NAME}"/>
    </springProfile>
    
    <!-- 日志文件名称 -->
    <property name="LOG_FILE" value="${LOG_PATH}/${APP_NAME}"/>
    
    <!-- ===================== 控制台输出配置 ===================== -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <springProfile name="dev">
                <pattern>%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr([%X{traceId:-}]){yellow} %clr(%5p) %clr(${PID:- }){magenta} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n%wEx</pattern>
            </springProfile>
            <springProfile name="test,prod">
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId:-}] %-5level [%thread] %logger{50} : %msg%n</pattern>
            </springProfile>
        </encoder>
    </appender>

    <!-- ===================== 文件输出配置 ===================== -->
    
    <!-- 应用日志文件 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}.log</file>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId:-}] [%X{userId:-}] [%X{operation:-}] %-5level [%thread] %logger{50} : %msg%n</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE}.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>50MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- 错误日志文件 -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}-error.log</file>
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId:-}] [%X{userId:-}] [%X{operation:-}] %-5level [%thread] %logger{50} : %msg%n%wEx</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE}-error.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>50MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>60</maxHistory>
            <totalSizeCap>2GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- SQL执行日志文件 -->
    <appender name="SQL_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}-sql.log</file>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId:-}] [%X{userId:-}] %-5level [%thread] %logger{50} : %msg%n</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE}-sql.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>15</maxHistory>
            <totalSizeCap>2GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- 安全审计日志文件 -->
    <appender name="SECURITY_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}-security.log</file>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId:-}] [%X{userId:-}] [%X{clientIp:-}] [%X{userAgent:-}] %-5level [%thread] %logger{50} : %msg%n</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE}-security.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>50MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>90</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- 业务日志文件 -->
    <appender name="BUSINESS_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}-business.log</file>
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{traceId:-}] [%X{userId:-}] [%X{operation:-}] %-5level [%thread] %logger{50} : %msg%n</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE}-business.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- ===================== 结构化JSON日志输出 (生产环境) ===================== -->
    <springProfile name="prod">
        <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${LOG_FILE}-json.log</file>
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp>
                        <timeZone>UTC</timeZone>
                    </timestamp>
                    <version/>
                    <logLevel/>
                    <message/>
                    <mdc/>
                    <arguments/>
                    <stackTrace/>
                    <pattern>
                        <pattern>
                            {
                                "application": "${APP_NAME}",
                                "hostname": "${HOSTNAME:-unknown}",
                                "pid": "${PID:-unknown}"
                            }
                        </pattern>
                    </pattern>
                </providers>
            </encoder>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>${LOG_FILE}-json.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                    <maxFileSize>100MB</maxFileSize>
                </timeBasedFileNamingAndTriggeringPolicy>
                <maxHistory>30</maxHistory>
                <totalSizeCap>10GB</totalSizeCap>
            </rollingPolicy>
        </appender>
    </springProfile>

    <!-- ===================== 异步日志配置 ===================== -->
    
    <!-- 异步应用日志 -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="FILE"/>
        <queueSize>4096</queueSize>
        <discardingThreshold>820</discardingThreshold>
        <maxFlushTime>1000</maxFlushTime>
        <neverBlock>true</neverBlock>
        <includeCallerData>false</includeCallerData>
    </appender>

    <!-- 异步错误日志 -->
    <appender name="ASYNC_ERROR_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="ERROR_FILE"/>
        <queueSize>2048</queueSize>
        <discardingThreshold>410</discardingThreshold>
        <maxFlushTime>1000</maxFlushTime>
        <neverBlock>false</neverBlock>
        <includeCallerData>true</includeCallerData>
    </appender>

    <!-- 异步业务日志 -->
    <appender name="ASYNC_BUSINESS_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="BUSINESS_FILE"/>
        <queueSize>2048</queueSize>
        <discardingThreshold>410</discardingThreshold>
        <maxFlushTime>1000</maxFlushTime>
        <neverBlock>true</neverBlock>
        <includeCallerData>false</includeCallerData>
    </appender>

    <!-- 异步安全日志 -->
    <appender name="ASYNC_SECURITY_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="SECURITY_FILE"/>
        <queueSize>1024</queueSize>
        <discardingThreshold>205</discardingThreshold>
        <maxFlushTime>1000</maxFlushTime>
        <neverBlock>false</neverBlock>
        <includeCallerData>true</includeCallerData>
    </appender>

    <!-- 异步SQL日志 -->
    <appender name="ASYNC_SQL_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="SQL_FILE"/>
        <queueSize>2048</queueSize>
        <discardingThreshold>410</discardingThreshold>
        <maxFlushTime>1000</maxFlushTime>
        <neverBlock>true</neverBlock>
        <includeCallerData>false</includeCallerData>
    </appender>

    <!-- ===================== 专用Logger配置 ===================== -->
    
    <!-- SQL日志 -->
    <logger name="com.codetop.mapper" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_SQL_FILE"/>
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>
    
    <!-- MyBatis日志 -->
    <logger name="org.apache.ibatis" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_SQL_FILE"/>
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- 安全相关日志 -->
    <logger name="com.codetop.security" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_SECURITY_FILE"/>
        <springProfile name="dev,test">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- 认证授权日志 -->
    <logger name="com.codetop.service.AuthService" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_SECURITY_FILE"/>
        <springProfile name="dev,test">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- JWT相关日志 -->
    <logger name="com.codetop.util.JwtUtil" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_SECURITY_FILE"/>
        <springProfile name="dev,test">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- 业务服务日志 -->
    <logger name="com.codetop.service" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_BUSINESS_FILE"/>
        <springProfile name="dev,test">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- 控制器日志 -->
    <logger name="com.codetop.controller" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_BUSINESS_FILE"/>
        <springProfile name="dev,test">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- FSRS算法日志 -->
    <logger name="com.codetop.algorithm" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_BUSINESS_FILE"/>
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- Spring Security日志 -->
    <logger name="org.springframework.security" level="WARN" additivity="false">
        <appender-ref ref="ASYNC_SECURITY_FILE"/>
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- Redis日志 -->
    <logger name="org.redisson" level="WARN" additivity="false">
        <appender-ref ref="ASYNC_FILE"/>
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- 数据库连接池日志 -->
    <logger name="com.alibaba.druid" level="WARN" additivity="false">
        <appender-ref ref="ASYNC_SQL_FILE"/>
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- HTTP请求日志 -->
    <logger name="org.springframework.web" level="WARN" additivity="false">
        <appender-ref ref="ASYNC_FILE"/>
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
    </logger>

    <!-- ===================== 根Logger配置 ===================== -->
    
    <!-- 开发环境 -->
    <springProfile name="dev">
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR_FILE"/>
        </root>
    </springProfile>
    
    <!-- 测试环境 -->
    <springProfile name="test">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR_FILE"/>
        </root>
    </springProfile>
    
    <!-- 生产环境 -->
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR_FILE"/>
            <appender-ref ref="JSON_FILE"/>
        </root>
    </springProfile>

</configuration>